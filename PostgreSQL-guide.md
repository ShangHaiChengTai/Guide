# PostgreSQL Guide

---	
## PostgreSQL规范

---

## 文档目录

1. [背景](#1-背景)
1. [设计规范](#2-设计规范)
1. [操作规范](#3-操作规范)
1. [备注](#4-备注)

---
## 1 背景

PostgreSQL功能异常强大，希望通过以下规范，使PostgreSQL的功能以及性能得以充分发挥，为应用层提供快准狠的数据服务。持续完善中，悉心接受各路意见和建议。


## 2 设计规范

### 2.1 命名规范

1. 数据库对象([备注1](#4-备注))使用小写字母，下划线和数字(经常不需要)的组合。

1. 数据库对象([备注1](#4-备注))长度不超过63字符。

1. 数据库对象([备注1](#4-备注))命名不要以postgre或者pg或者数字开头。

1. 数据库对象([备注1](#4-备注))命名禁止使用拼音或者[SQL关键字](https://www.postgresql.org/docs/current/static/sql-keywords-appendix.html)。

1. 数据库对象([备注1](#4-备注))命名尽量使用全名。当长度超过63字符时，可使用缩写来缩减长度。

1. 建议表的命名采用名词的复数形式。

1. 临时表以tmp_开头。

1. 备份的表，建议在名称后加上日期(tabel\_XXX_YYYYMMDD)。

1. 索引按照表名_列名_idx的规则命名，建议使用DBMS默认的索引名称。

### 2.2 数据库

1. 库名最好与应用名称一致，便于辨识。

1. 不建议使用public schema，给每个服务分配对应的一个或者多个schema。

1. 所有字符编码均采用UTF-8编码([备注2](#4-备注))。

### 2.3 数据表

1. 多张表中相同的列，以及有JOIN需求的列，务必保持列名和数据类型的一致。

1. 对于频繁更新的表，将填充因子(fillfactor)设置成85，每页预留15%的空间给HOT更新使用([备注3](#4-备注))。

1. 建议每张表都有主键，建议采用以下的写法：id serial primary key或者id bigserial primary key。

1. 建议不要使用有业务含义的字段作为主键，比如身份证号，尽管其是unique的。

1. 建议有定期历史数据删除需求的业务，表按时间分区，删除时不要使用DELETE操作，而是DROP或者TRUNCATE对应的表。

### 2.4 表字段

1. 建议能用数字类型的就不用字符类型。

1. 建议能用varchar(N)就不用char(N),以节省存储空间。

1. 建议能用varchar(N)就不用text,varchar。

1. 建议使用default NULL，而不用default ''，以节省存储空间。

1. 建议使用NUMERIC，而不用real, double precision来存储要求精确计算的数值。

1. 建议使用macaddr来存储MAC地址。

1. 对国际化业务有要求的时间字段，建议使用timestamptz来代替timestamp。

1. 建议使用NUMERIC(precision, scale)来存储金额相关的类型，在以分为单位的情况下也可以使用integer或者bigint。

1. 建议使用hstore来存储非结构化，key-value键值型。

1. 建议使用ltree来存储树状层次结构数据。

1. 建议使用jsonb来存储JSON(JavaScript Object Notation)数据。

1. 建议使用Geometric Types结合PostGIS来实现地理信息数据存储及操作。

1. 建议使用Range类型代替字符串或者多列来实现范围的存储([备注4](#4-备注))。

1. 表字段必须添加注释，便于后续的维护。

### 2.5 数据索引

1. 禁止重复索引。

1. 建议创建或者删除索引时，加CONCURRENTLY参数，达到与写入数据并发的效果。

1. 建议对WHERE中带多个字段AND的高频检索，参考数据的分布情况，建立多个字段的联合索引。

1. 如果表中针对一小部分数据存在相对于其他数据的高频访问，可以对这部分数据建立带WHERE条件的部分索引。

1. 建议对经常使用表达式作为查询条件的检索，可以使用表达式或者函数索引加速检索。

1. 建议不要建过多的索引，一般不超过6个。核心表可以适当增加索引个数。

## 3 操作规范

1. 为数据库访问账号设置复杂密码。

1. 开发测试以及相关业务操作，禁止使用数据库超级用户。禁止有超级权限的应用程序账号存在。

1. 禁止在生产环境上进行压力测试。

1. 禁止从测试、开发环境直接连接生产数据库。 

1. 禁止在数据库中存储明文密码等机密数据。

1. 避免使用[SELECT *]，只取需要的字段来减少网络带宽消耗。

1. 不要DELETE全表，请使用TRUNCATE代替。

1. 除了大数据量的数据分析，避免全表扫描。

1. 建议使用LIMIT(1)而不是COUNT(*)来判断是否有数据。

1. 不要使用COUNT(列名)或者COUNT(常量)代替COUNT(*)。

1. 数据语句查询中的别名不要使用小写字母，下划线，数字以外的字符，例如中文。

1. 查询时应当尽量避免全表扫描，优先考虑在WHERE以及ORDER BY的数据列上建立索引。

1. 建议使用数组变量代替临时表，只有数据量非常庞大时，才考虑使用临时表。

1. 避免频繁的创建和删除临时表，以减少系统表资源的消耗。

1. 程序中的定义的数据类型与表中定义的类型保持一致，避免报错或者无法使用索引的情况发生。

1. 表中对长度等有限制的字段，在程序中进行类型长度校验，以免造成脏数据的读入或者数据的丢失。

1. 建议复杂的统计查询可以尝试[窗口函数Window Functions](https://www.postgresql.org/docs/current/static/tutorial-window.html)。

1. 建议大批量数据写入时，使用COPY而不是INSERT以提高写入速度。

1. 建议对报表类或者生产基础数据的查询，使用物化视图(MATERIALIZED VIEW)定期固化数据快照，避免多表跑相同的查询。

1. 建议将单个事务中的多条表操作进行拆分或者不放在单个事务中，以缩小单个事务的粒度，减少LOCK资源，避免锁等待以及死锁的发生。

1. 在数据库事务中进行分页操作时，建议通过游标返回分页结果以防止越往后越慢的情况。

1. 建议在预估QUERY的执行时间，并在数据库事务中设置超时时间，以防止长时间持锁和雪崩的发生([备注5](#4-备注))。

1. 游标使用后应当就及时关闭。

1. 手动装载大量数据的时候，建议关闭自动vacuum，删除索引，数据导入后，进行analyze并创建索引。

1. 数据订正时，删除和修改记录时，要先SELECT，避免出现错误或者误删除，确认无误才能提交执行。

## 4 备注

1. 数据库对象：database/schema/table/view/column/index/sequence/function/trigger等。

1. 查看字符编码：show server_encoding;

1. 填充因子示例：CREATE TABLE sample(id serial, number integer) WITH (fillfactor=85);

1. pg支持的范围类型：int4range int8range numrange tsrange tstzrange daterange。

1. set local statement_timeout = '10s';
